<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>账号设置</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.css">
		<link rel="stylesheet" type="text/css" href="../../css/personalCenter/accountSettings.css"/>
	</head>

	<body class="mui-fullscreen">
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始<-->
		<div id="setting" class="mui-page">
			<!--页面标题栏开始-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav mui-badge-light-blue">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">账号设置</h1>
			</div>
			<!--<nav class="mui-bar mui-bar-tab">
				<button type="button" class="mui-btn mui-badge-light-blue mui-btn-block" id="logout">退出登录</button>
			</nav>-->
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper" style="padding-bottom: 50px;">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<a class="mui-navigate-right" href="#intention" id="amendPwd">
									<i class="mui-icon-extra mui-icon-extra-at"></i>修改密码
								</a>
							</li>
							<!--<li class="mui-table-view-cell">
								<a class="mui-navigate-right" href="#degree">
									<i class="mui-icon-extra mui-icon-extra-at"></i>修改个人信息
								</a>
							</li>-->
							<li class="mui-table-view-cell">
								<a class="mui-navigate-right" id="update">
									<i class="mui-icon-extra mui-icon-extra-at"></i>检查更新
								</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>
		<!--单页面结束-->
		<div id="intention" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav  mui-badge-light-blue">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">修改密码</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<form id='' class="mui-input-group">
							<div class="mui-input-row">
								<label><i class=""></i>账号</label>
								<input id='account' type="text" value="1259505412" class="mui-input" placeholder="" readonly="">
							</div>
							<div class="mui-input-row">
								<label>原密码</label>
								<input id='oldpassword' type="password" class=" mui-input" placeholder="请输入原密码">
							</div>
							<div class="mui-input-row">
								<label>新的密码</label>
								<input id='newpassword' type="password" class=" mui-input" placeholder="请输入6-20位新密码">
							</div>
						</form>
						<div class="mui-content-padded">
							<button  class="mui-btn mui-btn-block mui-badge-light-blue" style="color: #fff;" id="saveBtn">确认修改</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!--<div id="degree" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav  mui-badge-light-blue">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">修改个人信息</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div class="header" id="camera">
							<div class="imgbox">
								<img src="../../img/index/agent.png"/>
							</div>
							<p>点击修改头像</p>
						</div>
						<form id='' class="mui-input-group">
							<div class="mui-input-row">
								<label>姓名</label>
								<input id='account' type="text" class=" mui-input" placeholder="董大官人">
							</div>
							<div class="mui-input-row">
								<label>性别</label>
								<div class="mui-switch mui-switch-blue mui-pulllef sex">
								 	 <div class="mui-switch-handle"></div>
								</div>
							</div>
							<div class="mui-input-row">
								<label>联系电话</label>
								<input id='account' type="text" class=" mui-input" placeholder="18513552894">
							</div>
						</form>
						<div class="mui-content-padded">
							<button class="mui-btn mui-btn-block mui-badge-light-blue" style="color: #fff;">保存</button>
						</div>
					</div>
				</div>
			</div>
		</div>-->
		
	</body>
	<script src="../../js/jquery-1.11.0.js"></script>
	<script src="../../js/mui.min.js "></script>
	<script src="../../js/mui.view.js "></script>
	<script src="../../js/common.js"></script>
	<script>
		$('#amendPwd').on('tap',function(){
			$('#oldpassword').val('');
			$('#newpassword').val('');
		})
		//修改密码
		var userid = parseInt(localStorage.getItem('userId'));
		var loginName = localStorage.getItem('loginName');
		var loginPsd = localStorage.getItem('loginPsd');
		//将登陆的用户名赋值
		$('#account').val(loginName);
		
		$('#oldpassword').on('blur',function(){
			if($(this).val() != loginPsd){
				mui.alert('与原密码不符');
				$(this).val('');
			}else{
				$(this).val($(this).val());
			}
		})
		$('#newpassword').on('blur',function(){
			console.log($(this).val().length);
			if($(this).val().length < 5 || $(this).val().length > 12){
				mui.alert('请填写6-12位的密码');
				$(this).val('');
			}else if($('#newpassword').val() == $('#oldpassword').val()){
				mui.alert('新密码不可与原密码一样');
			}else{
				$(this).val($(this).val());
			}
		})
		//点击修改
		$('#saveBtn').on('tap',function(){
			console.log('1111111');
			mui.ajax(baseUrl+'API_PersonInfo/UpdatePassword?UserId='+userid+'&newPwd='+$('#newpassword').val()+'&oldPwd='+$('#oldpassword').val(),{
				dataType: 'json',
				type: 'post',
				success: function(data,type,status){
					if($('#oldpassword').val() != '' && $('#newpassword').val() != ''){
						if(data.succ){
							mui.openWindow({
								url:'_www/login.html',
								id:'login',
								show: {
									aniShow: 'pop-in',
									duration: '300',
								},
								waiting: {
									autoShow: true, //自动显示等待框，默认为true
									title: '飞速加载...', //等待对话框上显示的提示内容
								}
							})
						}else{
							mui.toast(msg);
						}
					}else{
						mui.toast('请输入完整的密码');
					}
				},error: function(txh,type,cont){
					console.log(type);
				}
			})
		})
		/*检查更新*/
		document.querySelector('#update').addEventListener("tap",function(){
			
			mui.ajax(baseUrl+'API_Dictionary/SysConfig',{
				dataType: 'json',
				type: 'post',
				success: function(data){ 
					mui.alert('版本：'+data.results.Copyright+',已经是最新版本','提示信息');			
				},error: function(error){
					console.log(error);
				}
			})
		});
		mui.init({
			swipeBack:true
		});
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#setting'
		});
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		var view = viewApi.view;
		(function($) {
			//处理view的后退与webview后退
			var oldBack = $.back;
			$.back = function() {
				if (viewApi.canBack()) { //如果view可以后退，则执行view的后退
					viewApi.back();
				} else { //执行webview后退
					oldBack();
				}
			};
			//监听页面切换事件方案1,通过view元素监听所有页面切换事件，目前提供pageBeforeShow|pageShow|pageBeforeBack|pageBack四种事件(before事件为动画开始前触发)
			//第一个参数为事件名称，第二个参数为事件回调，其中e.detail.page为当前页面的html对象
			view.addEventListener('pageBeforeShow', function(e) {
				//				console.log(e.detail.page.id + ' beforeShow');
			});
			view.addEventListener('pageShow', function(e) {
				//				console.log(e.detail.page.id + ' show');
			});
			view.addEventListener('pageBeforeBack', function(e) {
				//				console.log(e.detail.page.id + ' beforeBack');
			});
			view.addEventListener('pageBack', function(e) {
				//				console.log(e.detail.page.id + ' back');
			});
		})(mui);
		//调用照相机
		mui.plusReady(function(){
			mui('body').on('tap','#camera',function(e){
		  		plus.nativeUI.actionSheet( {title:"选择上传图片",cancel:"取消",buttons:[{title:"拍照"},{title:"从相册选择照片"}]}, function(e){
					switch (e.index){
						case 1:
							var cmr = plus.camera.getCamera();
							var res = cmr.supportedImageResolutions[0];
							var fmt = cmr.supportedImageFormats[0];
							console.log("Resolution: "+res+", Format: "+fmt);
							cmr.captureImage( function( path ){
									plus.io.resolveLocalFileSystemURL( path, function ( entry ) { 
										appendFile(entry.fullPath);
						        		mui.toast('上传成功',{ duration:'short', type:'div' });
							       }); 
								},
								function( error ) {
									console.log( "Capture image failed: " + error.message );
								},
								{resolution:res,format:fmt}
							);
							break;
						case 2:
							 plus.gallery.pick( function(path){
							 	mui.toast('上传成功',{ duration:'short', type:'div' });
						    	appendFile(path);
						    }, function ( e ) {
						    	console.log( "取消选择图片" );
						    }, {filter:"image"} );
							break;
						default:
							break;
					}
				});
		  		return false;
		  	});
		});
		
		// 添加文件
		var f1=null;
		function appendFile(path){
		  	var img = new Image();
		    img.src = path;        // 传过来的图片路径在这里用。
		    img.onload = function () {
		        var that = this;
		        //生成比例 
		        var w = that.width,
		            h = that.height,
		            scale = w / h; 
		            w = 480 || w;              //480  你想压缩到多大，改这里
		            h = w / scale;
		        //生成canvas
		        var canvas = document.createElement('canvas');
		        var ctx = canvas.getContext('2d');
		        $(canvas).attr({width : w, height : h});
		        ctx.drawImage(that, 0, 0, w, h);
		        var base64 = canvas.toDataURL('image/jpeg', 1 || 0.8 );   //1最清晰，越低越模糊。有一点不清楚这里明明设置的是jpeg。弹出 base64 开头的一段 data：image/png;却是png。哎开心就好，开心就好
		       	f1 =base64;   // 把base64数据丢过去，上传要用。
		//      var pic = document.getElementById("x");    
		//      pic.src = base64;                    //这里丢到img 的 src 里面就能看到效果了
		       $('#camera img').attr('src',base64);
			}
		}
		
		

		
		
	</script>

</html>